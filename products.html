<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Products - Outback Gems</title>
  <link rel="stylesheet" href="products.css" />
  <link rel="stylesheet" href="navbar.css" />
  <link href="https://fonts.googleapis.com/css2?family=Parisienne&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sacramento&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Allura&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Satisfy&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <div id="page-wrapper">
    <header id="navbar-container"></header>

    <div class="page-layout">
      <div class="side-menu">

        <!-- Lab-Grown Rough -->
        <div class="category-card" style="background-image: url('images/Synthetic Banner 1.jpg');">
          <div class="category-overlay">
            <span class="category-title side-menu-toggle" data-category="synthetic">Lab-Grown Rough</span>
            <button class="category-expand" type="button">&#9662;</button>
          </div>
          <ul class="subcategory-list">
            <li><a href="#" class="side-menu-toggle" data-category="synthetic-sapphire">Sapphire</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="synthetic-spinel">Spinel</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="synthetic-cubic-zirconia">Cubic Zirconia</a></li>
          </ul>
        </div>

        <!-- Natural Rough -->
        <div class="category-card" style="background-image: url('images/Natural Banner 1.jpg');">
          <div class="category-overlay">
            <span class="category-title side-menu-toggle" data-category="natural">Natural Rough</span>
            <button class="category-expand" type="button">&#9662;</button>
          </div>
          <ul class="subcategory-list">
            <li><a href="#" class="side-menu-toggle" data-category="natural-sapphire">Sapphire</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-topaz">Topaz</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-garnet">Garnet</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-spinel">Spinel</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-zircon">Zircon</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-quartz">Quartz</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-peridot">Peridot</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-tourmaline">Tourmaline</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-beryl">Beryl</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="natural-opal">Opal</a></li>
          </ul>
        </div>

        <!-- Other Items -->
        <div class="category-card" style="background-image: url('images/Other Banner 1.jpg');">
          <div class="category-overlay">
            <span class="category-title side-menu-toggle" data-category="other">Other Items</span>
            <button class="category-expand" type="button">&#9662;</button>
          </div>
          <ul class="subcategory-list">
            <li><a href="#" class="side-menu-toggle" data-category="fossicking-wash-bags">Fossicking Wash Bags</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="agate-thunder-eggs">Agate Thunder Eggs</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="meteorites">Meteorites</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="fluorescent-minerals">Fluorescent Minerals</a></li>
            <li><a href="#" class="side-menu-toggle" data-category="mystery-boxes">Mystery Boxes</a></li>
          </ul>
        </div>

        <!-- All Items (styled like other category cards, no accordion, links to all products) -->
        <div class="category-card" id="all-items-card" style="background-image: url('images/Contact\ Banner\ 2.jpeg');">
          <div class="category-overlay">
            <span class="category-title side-menu-toggle" data-category="">All Items</span>
            <!-- No expand button -->
          </div>
          <!-- No subcategory-list -->
        </div>
      </div>

      <div id="dynamic-product-container" class="product-container">
        <div class="dynamic-product-header-container">
          <div class="dynamic-product-header-title">Product Header</div>
          <hr class="product-header-divider" />
        </div>
        <!-- Product cards will be dynamically inserted here -->
      </div>
    </div>

    <footer>
      <div class="footer-left">
        <p><a href="Privacy Policy.docx" target="_blank">Privacy Policy</a></p>
        <p><a href="Terms of Use.docx" target="_blank">Terms Of Use</a></p>
      </div>
      <div class="footer-middle">
        <p>&copy; 2025 Outback Gems &amp; Minerals. All rights reserved.</p>
        <P>ABN: 0123456789</P>
      </div>
      <div class="footer-right">
        <p><a href="outbackgems@outlook.com"><i class="fa fa-envelope" aria-hidden="true" style="color:white"></i></a></p>
        <p><a href="https://www.facebook.com/"><i class="fa fa-facebook-square" aria-hidden="true" style="color:white"></i></a></p>
      </div>
    </footer>
  </div> <!-- End of page-wrapper -->

  <script src="navbar.js"></script>
  
  <script>
    // Dynamically load the shared navbar
    document.addEventListener('DOMContentLoaded', () => {
      fetch('navbar.html') // Ensure the file path is correct
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load navbar. Status: ${response.status}`);
          }
          return response.text();
        })
        .then(data => {
          document.querySelector('header').innerHTML = data;
        })
        .catch(error => {
          console.error('Error loading navbar:', error);
          document.querySelector('header').innerHTML = '<p style="color: red;">Failed to load navbar. Please try again later.</p>';
        });
    });
  </script>

  <script>
    // Dynamically load the navbar
    document.addEventListener("DOMContentLoaded", () => {
      fetch("navbar.html")
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load navbar. Status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          const navbarContainer = document.querySelector("header") || document.getElementById("navbar-container");
          if (navbarContainer) {
            navbarContainer.innerHTML = html;

            // Update the cart count and dropdown after the navbar is loaded
            updateCartCount();
            updateCartDropdown();
          }
        })
        .catch(error => {
          console.error("Error loading navbar:", error);
        });
    });

    // Function to update the cart count
    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartCountElement = document.getElementById("cart-count");

      if (cartCountElement) {
        cartCountElement.textContent = totalItems;
      } else {
        console.error("Cart count element not found in the navbar.");
      }
    }

    // Function to update the cart dropdown
    function updateCartDropdown() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const cartItemsList = document.getElementById("cart-items-list");
      const cartMessage = document.getElementById("cart-message");
      const cartSubtotal = document.getElementById("cart-subtotal");
      const cartTotal = document.getElementById("cart-total");

      if (!cartItemsList || !cartMessage || !cartSubtotal || !cartTotal) {
        console.error("Cart dropdown elements not found in the DOM.");
        return;
      }

      if (cart.length === 0) {
        cartMessage.textContent = "Your cart is empty.";
        cartItemsList.innerHTML = "";
        cartSubtotal.textContent = "$0.00";
        cartTotal.textContent = "$0.00";
        return;
      }

      let subtotal = 0;
      cartItemsList.innerHTML = ""; // Clear existing items

      cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;

        const cartItem = document.createElement("div");
        cartItem.classList.add("cart-item");

        cartItem.innerHTML = `
          <img src="${item.image}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
          <div class="cart-item-details">
            <span class="product-name">${item.name}</span>
            <span class="product-code">Code: ${item.id}</span>
            <span class="product-quantity">Qty: ${item.quantity}</span>
          </div>
          <div class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
        `;

        cartItemsList.appendChild(cartItem);
      });

      cartMessage.textContent = `You currently have ${cart.length} items in your cart.`;
      cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
      cartTotal.textContent = `$${subtotal.toFixed(2)}`;
    }

    // Listen for cart updates and refresh the dropdown
    document.addEventListener("cartUpdated", () => {
      updateCartCount();
      updateCartDropdown();
    });
</script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const productContainer = document.getElementById("dynamic-product-container");
      const productHeader = document.querySelector(".dynamic-product-header-title");

      // Function to get the query parameter value
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Get the category from the query parameter
      const categoryKeyword = getQueryParam("category");

      // Simulate a click on the corresponding side menu item if a category is provided
      if (categoryKeyword) {
        const sideMenuItem = document.querySelector(`.side-menu-toggle[data-category="${categoryKeyword}"]`);
        if (sideMenuItem) {
          // Trigger the click functionality
          loadProductsByCategory(categoryKeyword);
        } else {
          console.warn(`No side menu item found for category: ${categoryKeyword}`);
          loadProductsByCategory(); // Fallback to load all products
        }
      } else {
        loadProductsByCategory(); // Load all products if no category is specified
      }

      // Add event listeners to side menu toggles
      const sideMenuToggles = document.querySelectorAll(".side-menu-toggle");
      sideMenuToggles.forEach(toggle => {
        toggle.addEventListener("click", function () {
          const categoryKeyword = this.getAttribute("data-category"); // Get the keyword from the toggle

          // Update the URL dynamically without reloading the page
          const newUrl = `${window.location.pathname}?category=${encodeURIComponent(categoryKeyword)}`;
          history.pushState({ category: categoryKeyword }, "", newUrl);

          // Load products for the selected keyword
          loadProductsByCategory(categoryKeyword);
        });
      });

      // Function to load products by category keyword
      function loadProductsByCategory(keyword = null) {
        // Show loading indicator
        productContainer.innerHTML = "<p>Loading products...</p>";

        fetch("https://script.google.com/macros/s/AKfycbyCY8VW0D1A7AFJiU7X6tN5-RTrnYxQIV4QCzmFprxYrCVv2o4uKWnmKfJ6Xh40H4uqXA/exec")
          .then(response => response.json())
          .then(data => {
            if (data && data.length > 0) {
              let filteredProducts;

              // Filter products by keyword if a keyword is provided
              if (keyword) {
                filteredProducts = data.filter(product => product.category.includes(keyword));
              } else {
                // If no keyword is provided, display all products
                filteredProducts = data;
              }

              // Display filtered products
              const headerTitle = keyword ? formatCategoryHeader(keyword) : "All Products";
              displayProducts(filteredProducts, headerTitle, keyword, data);
            } else {
              productContainer.innerHTML = "<p>No products found.</p>";
            }
          })
          .catch(error => {
            console.error("Error fetching product data:", error);
            productContainer.innerHTML = "<p style='color: red;'>Failed to load products. Please try again later.</p>";
          });
      }

      const PRODUCTS_PER_PAGE = 6;
      let currentPage = 1;
      let currentProducts = [];

      // Function to display products
      function displayProducts(products, headerTitle, keyword, data, page = 1) {
        // Save products for paging
        currentProducts = products;
        currentPage = page;

        // Calculate pagination
        const totalPages = Math.ceil(products.length / PRODUCTS_PER_PAGE);
        const startIdx = (page - 1) * PRODUCTS_PER_PAGE;
        const endIdx = startIdx + PRODUCTS_PER_PAGE;
        const productsToShow = products.slice(startIdx, endIdx);

        // Clear the product container
        productContainer.innerHTML = "";

        // Create the header container
        const headerContainer = document.createElement("div");
        headerContainer.className = "dynamic-product-header-container";

        // Create the header title
        const headerTitleDiv = document.createElement("div");
        headerTitleDiv.className = "dynamic-product-header-title";
        headerTitleDiv.textContent = headerTitle;

        // Create the divider
        const divider = document.createElement("hr");
        divider.className = "product-header-divider";

        // Assemble and append the header
        headerContainer.appendChild(headerTitleDiv);
        headerContainer.appendChild(divider);
        productContainer.appendChild(headerContainer);

        // Display products for this page
        if (productsToShow.length > 0) {
          // Display the products
          productsToShow.forEach(product => {
            const productCard = document.createElement("div");
            productCard.classList.add("dynamic-product-card");
    
            // Image
            const imageContainer = document.createElement("div");
            imageContainer.classList.add("image-container");
            const img = document.createElement("img");
            img.src = product["image url"];
            img.alt = product["product name"] || "Product Image";
            imageContainer.appendChild(img);
    
            // Product name
            const productName = document.createElement("h3");
            productName.textContent = product["product name"];
    
            // Description
            const productDescription = document.createElement("p");
            productDescription.textContent = product.description;
    
            // Price per unit and unit (same line)
            const priceLine = document.createElement("p");
            priceLine.textContent = `$${product["price per unit"]} per ${product.unit}`;
    
            // Button with link to view-product.html?productname=XYZ
            const productButton = document.createElement("button");
            productButton.classList.add("dynamic-product-button");
            productButton.textContent = "View Details";
            productButton.onclick = () => {
              window.location.href = `view-product.html?productid=${encodeURIComponent(product["product id"])}`;
            };
    
            // Assemble card
            productCard.appendChild(imageContainer);
            productCard.appendChild(productName);
            productCard.appendChild(productDescription);
            productCard.appendChild(priceLine);
            productCard.appendChild(productButton);
    
            productContainer.appendChild(productCard);
          });

          // Add ghost cards to maintain grid layout
          const productsShown = productsToShow.length;

          // Always show one row (3 cards) if less than 4 products on this page
          if (productsToShow.length < 4) {
            const ghostCardsNeeded = 3 - productsToShow.length;
            for (let i = 0; i < ghostCardsNeeded; i++) {
              const ghostCard = document.createElement("div");
              ghostCard.className = "dynamic-product-card ghost-card";
              productContainer.appendChild(ghostCard);
            }
          } else {
            // Two rows: fill up to 6 cards
            const ghostCardsNeeded = 6 - productsShown;
            for (let i = 0; i < ghostCardsNeeded; i++) {
              const ghostCard = document.createElement("div");
              ghostCard.className = "dynamic-product-card ghost-card";
              productContainer.appendChild(ghostCard);
            }
          }

          // Show "You May Also Like" if fewer than 4 products in this category
          if (products.length < 4) {
            suggestAdditionalProducts(keyword, products, data);
          }
        } else {
          productContainer.innerHTML += "<p>No products found in this category.</p>";
          suggestAdditionalProducts(keyword, [], data);
        }

        // Pagination controls
        if (totalPages > 1) {
          const pagination = document.createElement("div");
          pagination.className = "pagination-controls";
          if (page > 1) {
            const prevBtn = document.createElement("button");
            prevBtn.textContent = "Previous";
            prevBtn.onclick = () => {
              displayProducts(currentProducts, headerTitle, keyword, data, page - 1);
              document.getElementById('dynamic-product-container').scrollIntoView({ behavior: 'smooth' });
            };
            pagination.appendChild(prevBtn);
          }
          pagination.appendChild(document.createTextNode(` Page ${page} of ${totalPages} `));
          if (page < totalPages) {
            const nextBtn = document.createElement("button");
            nextBtn.textContent = "Next";
            nextBtn.onclick = () => {
              displayProducts(currentProducts, headerTitle, keyword, data, page + 1);
              document.getElementById('dynamic-product-container').scrollIntoView({ behavior: 'smooth' });
            };
            pagination.appendChild(nextBtn);
          }
          productContainer.appendChild(pagination);
        }
      }

      // Function to suggest additional products
      function suggestAdditionalProducts(currentCategory, displayedProducts, data) {
        // Ensure displayedProducts is an array
        displayedProducts = displayedProducts || [];

        // Get the names of already displayed products
        const displayedProductNames = new Set(displayedProducts.map(product => product["product name"]));

        // Determine the broader category (e.g., "natural" or "synthetic")
        const broaderCategory = currentCategory.split("-")[0]; // Extract the first part of the category

        // Filter products from the broader category and exclude already displayed products
        const filteredSuggestions = data.filter(product => 
          product.category.includes(broaderCategory) && !displayedProductNames.has(product["product name"])
        );

        // Shuffle the suggestions and pick the first 3
        const shuffledSuggestions = filteredSuggestions.sort(() => 0.5 - Math.random()).slice(0, 3);

        // Create a container for suggested products
        const suggestionContainer = document.createElement("div");
        suggestionContainer.classList.add("suggestion-container");

        // Add suggestion header container with divider
        const suggestionHeaderContainer = document.createElement("div");
        suggestionHeaderContainer.className = "dynamic-product-header-container";

        // Create the divider and add it first
        const suggestionDivider = document.createElement("hr");
        suggestionDivider.className = "product-header-divider";
        suggestionHeaderContainer.appendChild(suggestionDivider);

        const suggestionHeader = document.createElement("div");
        suggestionHeader.className = "dynamic-product-header-title";
        suggestionHeader.textContent = "You May Also Like";
        suggestionHeaderContainer.appendChild(suggestionHeader);

        suggestionContainer.appendChild(suggestionHeaderContainer);

        // Check if there are suggestions
        if (shuffledSuggestions.length > 0) {
          // Display the suggestions
          shuffledSuggestions.forEach(product => {
            const productCard = document.createElement("div");
            productCard.classList.add("dynamic-product-card");

            // Image
            const imageContainer = document.createElement("div");
            imageContainer.classList.add("image-container");
            const img = document.createElement("img");
            img.src = product["image url"];
            img.alt = product["product name"] || "Product Image";
            imageContainer.appendChild(img);

            // Product name
            const productName = document.createElement("h3");
            productName.textContent = product["product name"];

            // Description
            const productDescription = document.createElement("p");
            productDescription.textContent = product.description;

            // Price per unit and unit (same line)
            const priceLine = document.createElement("p");
            priceLine.textContent = `$${product["price per unit"]} per ${product.unit}`;

            // Button with link to view-product.html?productname=XYZ
            const productButton = document.createElement("button");
            productButton.classList.add("dynamic-product-button");
            productButton.textContent = "View Details";
            productButton.onclick = () => {
              window.location.href = `view-product.html?productid=${encodeURIComponent(product["product id"])}`;
            };

            // Assemble card
            productCard.appendChild(imageContainer);
            productCard.appendChild(productName);
            productCard.appendChild(productDescription);
            productCard.appendChild(priceLine);
            productCard.appendChild(productButton);

            suggestionContainer.appendChild(productCard);
          });
        } else {
          // Add a fallback message if no suggestions are found
          const noSuggestionsMessage = document.createElement("p");
          noSuggestionsMessage.textContent = "No additional suggestions available.";
          suggestionContainer.appendChild(noSuggestionsMessage);
        }

        // Append the suggestion container to the product container
        productContainer.appendChild(suggestionContainer);
      }
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Accordion expand/collapse
      document.querySelectorAll('.category-expand').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const card = this.closest('.category-card');
          // Optionally close others:
          document.querySelectorAll('.category-card').forEach(c => {
            if (c !== card) c.classList.remove('open');
          });
          card.classList.toggle('open');
        });
      });

      // Dynamic loading for categories and subcategories
      document.querySelectorAll('.side-menu-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          const categoryKeyword = this.getAttribute('data-category');
          // Update the URL dynamically without reloading the page
          const newUrl = `${window.location.pathname}?category=${encodeURIComponent(categoryKeyword)}`;
          history.pushState({ category: categoryKeyword }, "", newUrl);
          // Load products for the selected keyword
          if (typeof loadProductsByCategory === "function") {
            loadProductsByCategory(categoryKeyword);
          }
        });
      });
    });
  </script>

  <script>
    function formatCategoryHeader(keyword) {
      if (!keyword) return "";
      return keyword
        .replace(/-/g, ' ')                // Replace dashes with spaces
        .replace(/\b\w/g, c => c.toUpperCase()); // Capitalize each word
    }
  </script>
</body>
</html>