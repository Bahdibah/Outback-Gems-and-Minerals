# Disable directory listing
Options -Indexes

# Disable server signature
ServerSignature Off

# --- MIME Types for Images ---
AddType image/jpeg .jpeg .jpg
AddType image/png .png
AddType image/gif .gif
AddType image/webp .webp
AddType image/bmp .bmp
AddType image/tiff .tif .tiff

# Force correct MIME types for images (especially in directories with spaces)
<Files ~ "\.(jpe?g)$">
    ForceType image/jpeg
</Files>

<Files ~ "\.png$">
    ForceType image/png
</Files>

<Files ~ "\.gif$">
    ForceType image/gif
</Files>

<Files ~ "\.webp$">
    ForceType image/webp
</Files>

<Files ~ "\.bmp$">
    ForceType image/bmp
</Files>

<Files ~ "\.(tif|tiff)$">
    ForceType image/tiff
</Files>

# --- Existing Redirect Rules ---
RewriteEngine On

# --- Block India by IP Ranges (PRECISE - India-only ISPs) ---
# Specific Indian ISP allocations that don't overlap with Australia
# Covers ~60-70% of Indian traffic without blocking Australian IPs
# For better blocking, use Cloudflare country-level rules (see end of file)
<RequireAll>
    Require all granted
    # Reliance Jio (India's largest ISP - 400M+ subscribers)
    Require not ip 49.37.0.0/16
    Require not ip 49.44.0.0/14
    Require not ip 106.192.0.0/11
    Require not ip 171.48.0.0/12
    
    # Bharti Airtel (India's 2nd largest - 350M+ subscribers)
    Require not ip 49.205.0.0/16
    Require not ip 106.206.0.0/15
    Require not ip 117.192.0.0/14
    Require not ip 125.16.0.0/13
    
    # BSNL (State-owned telecom)
    Require not ip 49.248.0.0/13
    Require not ip 59.88.0.0/13
    Require not ip 117.239.0.0/16
    
    # Vodafone Idea (Vi)
    Require not ip 106.208.0.0/12
    Require not ip 110.224.0.0/12
    
    # Tata Communications / Tata Teleservices
    Require not ip 121.240.0.0/13
    Require not ip 115.110.0.0/15
    
    # ACT Fibernet
    Require not ip 49.207.0.0/16
    
    # Hathway / YOU Broadband
    Require not ip 14.96.0.0/12
    Require not ip 117.196.0.0/14
</RequireAll>

# ⚠️ IMPORTANT: For comprehensive India blocking without false positives:
# Use Cloudflare's geographic blocking (instructions at end of this file)

# --- Protection Against Sensitive File Access ---
# Block access to sensitive files and directories
<FilesMatch "(\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect .git directory
<IfModule mod_rewrite.c>
    RewriteRule ^\.git - [F,L]
</IfModule>

# Block access to package files
<FilesMatch "(package\.json|package-lock\.json|composer\.json|composer\.lock)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# --- Allow PayPal and Stripe Webhooks/API Calls ---
<IfModule mod_rewrite.c>
    # Whitelist known payment processor user agents
    RewriteCond %{HTTP_USER_AGENT} (PayPal|Stripe|paypal) [NC]
    RewriteRule .* - [L]
</IfModule>

# --- Allow Netlify Functions (Webhooks) ---
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} ^/.netlify/functions/ [NC]
    RewriteRule .* - [L]
</IfModule>

# --- Block Suspicious User Agents (Conservative - No False Positives) ---
<IfModule mod_rewrite.c>
    # Only block obvious malicious tools and scanners
    # Does NOT block empty user agents or legitimate browsers
    RewriteCond %{HTTP_USER_AGENT} (libwww|nikto|masscan|nmap|zgrab|shodan|censys) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (sqlmap|havij|acunetix|netsparker|burpsuite) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (dirbuster|gobuster|wpscan|joomla scan|drupal scan) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# --- Block Common Exploit Attempts ---
<IfModule mod_rewrite.c>
    # Block SQL injection attempts - SMART DETECTION (multiple suspicious patterns required)
    # Only blocks when SQL keywords appear WITH suspicious syntax patterns
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (union.*select|select.*from.*where|insert.*into|drop.*table|update.*set|delete.*from) [NC,OR]
    RewriteCond %{QUERY_STRING} (concat.*\(|cast.*\(|declare.*@|exec.*\() [NC]
    RewriteRule .* - [F,L]
    
    # Block PHP injection attempts
    RewriteCond %{QUERY_STRING} (\.\.\/|\.\.\\|php:\/\/|file:\/\/|proc\/self\/environ) [NC,OR]
    RewriteCond %{QUERY_STRING} (base64_encode.*\(|base64_decode.*\(|eval.*\(|exec.*\() [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ✅ Exclude critical static files from Prerender.io
RewriteCond %{REQUEST_URI} ^/robots\.txt([/?].*)?$ [NC]
RewriteRule .* - [L]

RewriteCond %{REQUEST_URI} ^/sitemap\.xml([/?].*)?$ [NC]
RewriteRule .* - [L]

RewriteCond %{REQUEST_URI} ^/favicon\.ico$ [NC]
RewriteRule .* - [L]

# ✅ Specifically exclude images directory from Prerender (PRIORITY - must be before general static files rule)
RewriteCond %{REQUEST_URI} ^/images/ [NC]
RewriteRule .* - [L]

# Exclude other static files from Prerender
RewriteCond %{REQUEST_URI} \.(js|css|xml|gif|jpg|jpeg|png|svg|webp|woff|woff2|ttf|eot|ico|bmp|tiff)$ [NC]
RewriteRule .* - [L]

# ✅ Redirect sitemap.txt -> sitemap.xml
RewriteCond %{REQUEST_URI} ^/sitemap\.txt$ [NC]
RewriteRule ^sitemap\.txt$ https://outbackgems.com.au/sitemap.xml [R=301,L]

# Redirect www to non-www (and force HTTPS)
RewriteCond %{HTTP_HOST} ^www\.outbackgems\.com\.au [NC]
RewriteRule ^(.*)$ https://outbackgems.com.au/$1 [L,R=301]

# Redirect HTTP to HTTPS (for non-www)
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} ^outbackgems\.com\.au [NC]
RewriteRule ^(.*)$ https://outbackgems.com.au/$1 [L,R=301]

# Only apply Prerender to bot user agents, not regular users
RewriteCond %{HTTP_USER_AGENT} (googlebot|bingbot|yahoo|baiduspider|facebookexternalhit|twitterbot) [NC]
RequestHeader set X-Prerender-Token "jB2NVBnrYbku2t67YS1V"
RewriteRule ^(.*)$ https://service.prerender.io/https://outbackgems.com.au/$1 [P,L]


# --- Security Headers ---

# Prevent clickjacking and other attacks
Header set Content-Security-Policy "default-src 'self'; img-src 'self' data: https: *.paypal.com *.paypalobjects.com www.facebook.com www.gstatic.com *.synchronycredit.com; script-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com https://cdn.jsdelivr.net https://js.stripe.com https://www.paypal.com https://www.paypalobjects.com https://www.sandbox.paypal.com https://checkout.paypal.com https://*.paypal.cn https://objects.paypal.cn https://www.gstatic.com https://*.synchronycredit.com https://synchronycredit.com https://www.datadoghq-browser-agent.com https://static.novacredit.com https://script.googleusercontent.com https://www.google.com https://www.gstatic.com/recaptcha/ https://www.recaptcha.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://www.paypalobjects.com; font-src 'self' data: https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; connect-src 'self' https://script.googleusercontent.com https://script.google.com https://cdn.jsdelivr.net https://js.stripe.com https://www.paypal.com https://www.paypalobjects.com https://www.sandbox.paypal.com https://checkout.paypal.com https://cors-anywhere.herokuapp.com https://www.datadoghq-browser-agent.com https://outbackgems.netlify.app https://www.google.com/recaptcha/; worker-src 'self' blob: https://*.paypal.com; frame-src 'self' https://*.paypal.com https://*.paypalobjects.com https://www.sandbox.paypal.com https://js.stripe.com https://www.google.com/recaptcha/ https://www.recaptcha.net/recaptcha/;"
Header set Permissions-Policy "geolocation=(), microphone=(), camera=(), fullscreen=(self), payment=(self)"
Header set X-Content-Type-Options "nosniff"
Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
Header set Referrer-Policy "strict-origin-when-cross-origin"
Header always append X-Frame-Options SAMEORIGIN

# Additional security headers
Header set X-XSS-Protection "1; mode=block"
Header set X-Permitted-Cross-Domain-Policies "none"
Header always unset X-Powered-By
Header unset Server

# --- AGGRESSIVE SHORT-TERM CACHING FOR NEW SITE LAUNCH ---
# This section forces browsers to fetch fresh content during site redesign
# ⚠️ SWITCH TO LONG-TERM CACHING AFTER 2-3 WEEKS (see instructions below)

<IfModule mod_expires.c>
    ExpiresActive On
    
    # HTML/JSON - SHORT CACHE (30 minutes - fresh content without disrupting sessions)
    ExpiresByType text/html "access plus 1800 seconds"
    ExpiresByType application/json "access plus 1800 seconds"
    
    # CSS/JS - SHORT CACHE (30 minutes - forces updates without session disruption)
    ExpiresByType text/css "access plus 1800 seconds"
    ExpiresByType application/javascript "access plus 1800 seconds"
    ExpiresByType text/javascript "access plus 1800 seconds"
    
    # Images - SHORT CACHE (1 hour - balance between performance and freshness)
    ExpiresByType image/jpeg "access plus 1 hour"
    ExpiresByType image/jpg "access plus 1 hour"
    ExpiresByType image/png "access plus 1 hour"
    ExpiresByType image/gif "access plus 1 hour"
    ExpiresByType image/webp "access plus 1 hour"
    ExpiresByType image/svg+xml "access plus 1 hour"
    ExpiresByType image/x-icon "access plus 1 hour"
    
    # Fonts - MODERATE CACHE (1 day)
    ExpiresByType font/ttf "access plus 1 day"
    ExpiresByType font/woff "access plus 1 day"
    ExpiresByType font/woff2 "access plus 1 day"
    ExpiresByType application/font-woff "access plus 1 day"
    ExpiresByType application/font-woff2 "access plus 1 day"
</IfModule>

# Force revalidation for HTML/JSON (30 min cache with revalidation)
<FilesMatch "\.(html|json)$">
    Header set Cache-Control "public, max-age=1800, must-revalidate"
</FilesMatch>

# Short cache for CSS/JS with must-revalidate (30 minutes)
<FilesMatch "\.(css|js)$">
    Header set Cache-Control "public, max-age=1800, must-revalidate"
</FilesMatch>

# --- INSTRUCTIONS FOR SWITCHING TO LONG-TERM CACHING ---
# After 2-3 weeks when site is stable, replace the above section with:
#
# <IfModule mod_expires.c>
#     ExpiresActive On
#     ExpiresByType text/html "access plus 1 hour"
#     ExpiresByType application/json "access plus 1 hour"
#     ExpiresByType text/css "access plus 1 year"
#     ExpiresByType application/javascript "access plus 1 year"
#     ExpiresByType text/javascript "access plus 1 year"
#     ExpiresByType image/jpeg "access plus 1 year"
#     ExpiresByType image/jpg "access plus 1 year"
#     ExpiresByType image/png "access plus 1 year"
#     ExpiresByType image/gif "access plus 1 year"
#     ExpiresByType image/webp "access plus 1 year"
#     ExpiresByType font/ttf "access plus 1 year"
#     ExpiresByType font/woff "access plus 1 year"
#     ExpiresByType font/woff2 "access plus 1 year"
# </IfModule>
#
# <FilesMatch "\.(css|js|jpg|jpeg|png|gif|webp|woff|woff2|ttf)$">
#     Header set Cache-Control "public, max-age=31536000, immutable"
# </FilesMatch>

# ============================================================================
# CLOUDFLARE GEOGRAPHIC BLOCKING SETUP (RECOMMENDED)
# ============================================================================
# For more accurate and comprehensive India blocking, use Cloudflare's
# country-level blocking which is more reliable than IP ranges.
#
# SETUP INSTRUCTIONS:
# 
# 1. Sign up for Cloudflare (free plan): https://dash.cloudflare.com/sign-up
# 
# 2. Add your domain (outbackgems.com.au):
#    - Click "Add a Site"
#    - Enter: outbackgems.com.au
#    - Choose FREE plan
# 
# 3. Update nameservers at your domain registrar:
#    - Cloudflare will provide 2 nameservers (e.g., bob.ns.cloudflare.com)
#    - Replace your current nameservers with Cloudflare's
#    - Wait 24 hours for DNS propagation
# 
# 4. Enable country blocking:
#    - Go to Security > WAF > Create firewall rule
#    - Rule name: "Block India"
#    - Expression:
#      (ip.geoip.country eq "IN")
#    - Action: Block
#    - Click "Deploy"
# 
# 5. BENEFITS over IP blocking:
#    ✅ 99.9% accurate (uses MaxMind GeoIP2 database)
#    ✅ No risk of blocking Australian IPs
#    ✅ Automatically updated as IP allocations change
#    ✅ Also provides:
#       - DDoS protection (Layer 3/4/7)
#       - Free SSL certificate
#       - CDN/caching (faster site globally)
#       - Bot protection
#       - Analytics
# 
# 6. Once Cloudflare is active, DISABLE the htaccess IP blocking above
#    (comment out lines 42-68) to avoid redundancy
# 
# ============================================================================